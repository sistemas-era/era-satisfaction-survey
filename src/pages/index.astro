---
import Layout from '../layouts/layout.astro'
import { QUESTIONS } from '../constants'
---

<Layout title="Encuesta de Satisfacción">
  <header class="flex min-h-screen flex-col">
    <img class="w-full" src="banner.png" alt="" />
    <div
      class="mx-auto mt-6 flex h-full max-w-6xl flex-1 flex-col justify-center space-y-4 px-4 text-justify"
    >
      <p>
        Para el <strong>ESTUDIO RODRÍGUEZ ANGOBALDO S.A.C.</strong>, la opinión de nuestros clientes
        es esencial para el crecimiento y mejora continua de nuestros servicios.
      </p>
      <p>
        Te invitamos a participar en esta <strong>encuesta de satisfacción</strong>, cuyo objetivo
        es recoger tus percepciones y sugerencias sobre la calidad de nuestra atención y desempeño
        profesional
      </p>
      <p>
        La información que nos proporciones será tratada con absoluta confidencialidad y utilizada
        exclusivamente con fines de mejora
      </p>

      <section class="mt-2 grid gap-8 md:grid-cols-2">
        <div class="flex flex-col gap-2">
          <label for="company" class="text-base font-semibold text-gray-700"> Cliente </label>
          <input
            id="company"
            name="clientCompany"
            type="text"
            placeholder="Ej: Acme S.A."
            required
            class="bg-secondary h-12 rounded-xl px-4 text-gray-800 placeholder-gray-500 focus:ring-1 focus:ring-[#b5dce5] focus:outline-none"
          />
        </div>

        <div class="flex flex-col gap-2">
          <label for="person" class="text-base font-semibold text-gray-700">
            Nombre del encuestado
          </label>
          <input
            id="person"
            name="clientPerson"
            type="text"
            placeholder="Ej: María Pérez"
            required
            class="bg-secondary h-12 rounded-xl px-4 text-gray-800 placeholder-gray-500 focus:ring-1 focus:ring-[#b5dce5] focus:outline-none"
          />
        </div>
      </section>
    </div>
  </header>
  <main class="pt-8">
    <div class="bg-primary px-4 py-8 text-white">
      <h2 class="text-center text-2xl font-semibold">EVALUACIÓN DE ASPECTOS DEL SERVICIO</h2>
      <p class="mt-2 text-center">
        Señale del 1 al 5 el valor de la escala que más se identifique con su opinión, donde 5 es el
        valor más alto y 1 el valor más bajo.
      </p>
    </div>
    <form id="survey-form">
      <section class="mx-auto mt-6 max-w-6xl px-4">
        <div class="grid-cols-[3fr_4fr] items-center gap-x-10 md:grid">
          <div></div>
          <div class="flex flex-col items-center">
            <div
              class="text-primary grid w-full grid-cols-5 gap-3 text-center text-sm font-semibold"
            >
              <div>
                5<br />
                <span class="font-normal">Muy alto</span>
              </div>
              <div>
                4<br />
                <span class="font-normal">Alto</span>
              </div>
              <div>
                3<br />
                <span class="font-normal">Medio</span>
              </div>
              <div>
                2<br />
                <span class="font-normal">Bajo</span>
              </div>
              <div>
                1<br />
                <span class="font-normal">Muy bajo</span>
              </div>
            </div>

            <div
              class="mt-2 h-1.5 w-full rounded-sm bg-gradient-to-r from-green-700 via-yellow-400 to-red-600"
            >
            </div>
          </div>
        </div>
      </section>

      <section class="mt-4">
        {
          QUESTIONS.map(({ key, label }, i) => (
            <div class="odd:bg-secondary py-8">
              <div class="mx-auto max-w-6xl grid-cols-[3fr_4fr] items-center gap-x-10 px-4 md:grid">
                <legend class="text-justify text-sm text-gray-600">
                  <span class="mr-2 text-gray-500">{i + 1}.</span>
                  {label} <span class="text-red-600">*</span>
                </legend>
                <div class="mt-2 grid grid-cols-5 gap-2 md:mt-0 md:gap-3">
                  {[5, 4, 3, 2, 1].map((val) => (
                    <label class="relative flex h-11 cursor-pointer items-center justify-center rounded-xl border border-gray-300 select-none hover:border-gray-400">
                      <input type="radio" name={key} value={val} required class="peer sr-only" />
                      <span class="absolute inset-0 z-20 grid place-items-center text-sm font-medium peer-checked:text-white">
                        {val}
                      </span>
                      <span class="bg-primary absolute inset-0 z-10 rounded-xl opacity-0 transition peer-checked:opacity-90" />
                    </label>
                  ))}
                </div>
              </div>
            </div>
          ))
        }
      </section>

      <section class="mx-auto mt-4 max-w-6xl space-y-3 px-4">
        <label for="comment" class="text-primary font-semibold uppercase"
          >Sugerencias de Mejora</label
        >
        <p class="text-sm text-gray-600">
          Por favor, comparta cualquier comentario adicional o sugerencia sobre cómo podríamos
          mejorar nuestros servicios.
        </p>
        <textarea
          id="suggestions"
          name="suggestions"
          rows="4"
          placeholder="Cuéntanos cómo podemos mejorar…"
          class="bg-secondary mt-1 w-full rounded-xl border border-gray-300 px-3 py-2 text-gray-800 placeholder-gray-500 focus:ring-1 focus:ring-gray-200 focus:outline-none"
        ></textarea>
        <p class="text-sm text-gray-500">
          Los campos marcados con <span class="text-red-600">*</span> son obligatorios.
        </p>
      </section>

      <section class="mx-auto mt-4 flex max-w-6xl items-center justify-end gap-4 px-4">
        <button
          type="submit"
          class="text-md h-11 cursor-pointer rounded-xl bg-gray-900 px-20 font-medium text-white uppercase transition hover:opacity-90"
          >Enviar</button
        >
      </section>
    </form>

    <div
      id="loading-layer"
      class="fixed inset-0 z-50 hidden place-items-center justify-center bg-black/70"
    >
      <img src="/logo_era.png" alt="Logo ERA" class="animate-pulse-scale md:w-80" />
    </div>

    <footer class="py-8 text-center text-sm text-gray-500">
      <p class="font-semibold">Gracias por tu tiempo y por ayudarnos a mejorar</p>
      <p>
        En el Estudio Rodriguez Angobaldo S.A.C. valoramos tu confianza y trabajamos cada día para
        ofrecerte un servicio legal de excelencia
      </p>
    </footer>
  </main>
</Layout>

<script>
  const $form = document.querySelector('#survey-form') as HTMLFormElement
  const $loading = document.querySelector('#loading-layer') as HTMLDivElement

  const toggleLoading = () => {
    $loading.classList.toggle('hidden')
    $loading.classList.toggle('grid')
    document.body.classList.toggle('overflow-hidden')
  }

  $form.addEventListener('submit', async (e) => {
    e.preventDefault()

    toggleLoading()

    const fd = new FormData($form)
    const payload = Object.fromEntries(fd.entries())

    const $client = document.querySelector('[name="clientCompany"]') as HTMLInputElement
    const $person = document.querySelector('[name="clientPerson"]') as HTMLInputElement

    if (!$client.value.trim() || !$person.value.trim()) {
      alert('Por favor, completa los campos obligatorios.')
      toggleLoading()
      return
    }

    const params = new URLSearchParams(window.location.search)
    const unidad = params.get('unidad') ?? 'general'

    payload.clientCompany = $client.value
    payload.clientPerson = $person.value
    payload.group = unidad

    try {
      const res = await fetch('/api/surveys/satisfaction', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify(payload),
      })

      if (res.ok) {
        alert('¡Gracias por tu respuesta!')
        $form.reset()
      } else {
        alert('Error al enviar la encuesta.')
      }
    } catch (err) {
      console.error(err)
      alert('Error de conexión. Intenta nuevamente.')
    } finally {
      toggleLoading()
    }
  })
</script>
